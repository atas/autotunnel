services:
  kind:
    build:
      context: .
      dockerfile: Dockerfile.kind
    privileged: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./manifests:/manifests:ro
      - kubeconfig:/output
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # Clean up any existing cluster
        kind delete cluster --name autotunnel-test 2>/dev/null || true

        # Create KIND cluster
        kind create cluster --name autotunnel-test --wait 120s

        # Export kubeconfig
        kind get kubeconfig --name autotunnel-test > /output/kubeconfig

        # Fix kubeconfig to use the Docker network IP instead of localhost
        # Get the control plane container IP
        CONTROL_PLANE_IP=$$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' autotunnel-test-control-plane)
        sed -i "s/127.0.0.1:[0-9]*/$$CONTROL_PLANE_IP:6443/g" /output/kubeconfig

        echo "Waiting for cluster to be ready..."
        until kubectl --kubeconfig=/output/kubeconfig get nodes >/dev/null 2>&1; do
          echo "Waiting for API server..."
          sleep 2
        done

        # Apply test manifests
        echo "Applying test manifests..."
        kubectl --kubeconfig=/output/kubeconfig apply -f /manifests/

        # Wait for pods to be ready
        echo "Waiting for nginx pod..."
        kubectl --kubeconfig=/output/kubeconfig wait --for=condition=ready pod -l app=nginx -n autotunnel-test --timeout=180s
        echo "Waiting for echo pod..."
        kubectl --kubeconfig=/output/kubeconfig wait --for=condition=ready pod -l app=echo -n autotunnel-test --timeout=180s
        echo "Waiting for tcp-echo pod..."
        kubectl --kubeconfig=/output/kubeconfig wait --for=condition=ready pod -l app=tcp-echo -n autotunnel-test --timeout=180s
        echo "Waiting for tcp-echo-alt pod..."
        kubectl --kubeconfig=/output/kubeconfig wait --for=condition=ready pod -l app=tcp-echo-alt -n autotunnel-test --timeout=180s
        echo "Waiting for tcp-echo-standalone pod..."
        kubectl --kubeconfig=/output/kubeconfig wait --for=condition=ready pod/tcp-echo-standalone -n autotunnel-test --timeout=180s

        echo "Cluster ready!"
        tail -f /dev/null
    healthcheck:
      test: ["CMD", "sh", "-c", "kubectl --kubeconfig=/output/kubeconfig get nodes 2>/dev/null | grep -q Ready"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 90s

  test:
    image: golang:1.25-alpine
    depends_on:
      kind:
        condition: service_healthy
    volumes:
      - ../..:/app
      - kubeconfig:/kubeconfig:ro
      - go-cache:/go/pkg
    working_dir: /app
    environment:
      - KUBECONFIG=/kubeconfig/kubeconfig
      - K8S_CONTEXT=kind-autotunnel-test
      - CGO_ENABLED=0
    command: >
      sh -c "
        echo 'Building autotunnel...' &&
        go build -o autotunnel . &&
        echo 'Running integration tests...' &&
        go test -v -tags=integration ./tests/integration/...
      "

volumes:
  kubeconfig:
  go-cache:
