---
# Namespace for integration tests
apiVersion: v1
kind: Namespace
metadata:
  name: autotunnel-test
---
# Simple nginx deployment for testing HTTP port-forwarding
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: autotunnel-test
  labels:
    app: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:alpine
          ports:
            - containerPort: 80
          readinessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 2
            periodSeconds: 3
---
# Service for nginx
apiVersion: v1
kind: Service
metadata:
  name: nginx
  namespace: autotunnel-test
spec:
  selector:
    app: nginx
  ports:
    - port: 80
      targetPort: 80
---
# Echo server for more advanced testing (returns request info)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo
  namespace: autotunnel-test
  labels:
    app: echo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: echo
  template:
    metadata:
      labels:
        app: echo
    spec:
      containers:
        - name: echo
          image: hashicorp/http-echo
          args:
            - "-text=autotunnel-integration-test"
            - "-listen=:8080"
          ports:
            - containerPort: 8080
          readinessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 2
            periodSeconds: 3
---
# Service for echo
apiVersion: v1
kind: Service
metadata:
  name: echo
  namespace: autotunnel-test
spec:
  selector:
    app: echo
  ports:
    - port: 8080
      targetPort: 8080
---
# ============================================================================
# Additional test services for expanded integration test coverage
# ============================================================================

# ConfigMap for nginx TLS configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-tls-config
  namespace: autotunnel-test
data:
  nginx.conf: |
    events { worker_connections 1024; }
    http {
        server {
            listen 443 ssl;
            server_name nginx-tls.test localhost;
            ssl_certificate /etc/nginx/ssl/tls.crt;
            ssl_certificate_key /etc/nginx/ssl/tls.key;
            ssl_protocols TLSv1.2 TLSv1.3;
            location / {
                return 200 'autotunnel-tls-integration-test\n';
                add_header Content-Type text/plain;
            }
            location /health { return 200 'OK'; }
        }
    }
---
# nginx deployment with TLS using init container for certificate generation
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-tls
  namespace: autotunnel-test
  labels:
    app: nginx-tls
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx-tls
  template:
    metadata:
      labels:
        app: nginx-tls
    spec:
      initContainers:
        - name: generate-certs
          image: alpine:latest
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache openssl &&
              printf '[req]\ndistinguished_name=dn\nx509_extensions=v3\nprompt=no\n[dn]\nCN=nginx-tls.test\n[v3]\nsubjectAltName=DNS:nginx-tls.test,DNS:localhost\n' > /tmp/ssl.cnf &&
              openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /ssl/tls.key -out /ssl/tls.crt -config /tmp/ssl.cnf &&
              chmod 644 /ssl/tls.crt && chmod 600 /ssl/tls.key &&
              ls -la /ssl/
          volumeMounts:
            - name: ssl-certs
              mountPath: /ssl
      containers:
        - name: nginx
          image: nginx:alpine
          ports:
            - containerPort: 443
          volumeMounts:
            - name: ssl-certs
              mountPath: /etc/nginx/ssl
            - name: nginx-config
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
          readinessProbe:
            exec:
              command: ["wget", "--no-check-certificate", "-qO/dev/null", "https://127.0.0.1:443/health"]
            initialDelaySeconds: 5
            periodSeconds: 3
            timeoutSeconds: 3
      volumes:
        - name: ssl-certs
          emptyDir: {}
        - name: nginx-config
          configMap:
            name: nginx-tls-config
---
# Service for nginx-tls
apiVersion: v1
kind: Service
metadata:
  name: nginx-tls
  namespace: autotunnel-test
spec:
  selector:
    app: nginx-tls
  ports:
    - port: 443
      targetPort: 443
---
# Echo server with named ports for testing named port resolution
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-named-ports
  namespace: autotunnel-test
  labels:
    app: echo-named-ports
spec:
  replicas: 1
  selector:
    matchLabels:
      app: echo-named-ports
  template:
    metadata:
      labels:
        app: echo-named-ports
    spec:
      containers:
        - name: echo
          image: hashicorp/http-echo
          args: ["-text=named-port-test", "-listen=:8080"]
          ports:
            - containerPort: 8080
              name: http
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 2
            periodSeconds: 3
---
# Service for echo-named-ports with named targetPort
apiVersion: v1
kind: Service
metadata:
  name: echo-named-ports
  namespace: autotunnel-test
spec:
  selector:
    app: echo-named-ports
  ports:
    - port: 80
      targetPort: http
      name: http
---
# Multi-port service with three containers on different ports
apiVersion: apps/v1
kind: Deployment
metadata:
  name: multi-port
  namespace: autotunnel-test
  labels:
    app: multi-port
spec:
  replicas: 1
  selector:
    matchLabels:
      app: multi-port
  template:
    metadata:
      labels:
        app: multi-port
    spec:
      containers:
        - name: api
          image: hashicorp/http-echo
          args: ["-text=api-response", "-listen=:8080"]
          ports:
            - containerPort: 8080
              name: api
          readinessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 2
            periodSeconds: 3
        - name: admin
          image: hashicorp/http-echo
          args: ["-text=admin-response", "-listen=:8081"]
          ports:
            - containerPort: 8081
              name: admin
        - name: metrics
          image: hashicorp/http-echo
          args: ["-text=metrics-response", "-listen=:8082"]
          ports:
            - containerPort: 8082
              name: metrics
---
# Service for multi-port with all three ports exposed
apiVersion: v1
kind: Service
metadata:
  name: multi-port
  namespace: autotunnel-test
spec:
  selector:
    app: multi-port
  ports:
    - port: 8080
      targetPort: 8080
      name: api
    - port: 8081
      targetPort: 8081
      name: admin
    - port: 8082
      targetPort: 8082
      name: metrics
---
# WebSocket echo server for testing WebSocket upgrade handling
apiVersion: apps/v1
kind: Deployment
metadata:
  name: websocket-echo
  namespace: autotunnel-test
  labels:
    app: websocket-echo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: websocket-echo
  template:
    metadata:
      labels:
        app: websocket-echo
    spec:
      containers:
        - name: echo
          image: jmalloc/echo-server:latest
          ports:
            - containerPort: 8080
          readinessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 2
            periodSeconds: 3
---
# Service for websocket-echo
apiVersion: v1
kind: Service
metadata:
  name: websocket-echo
  namespace: autotunnel-test
spec:
  selector:
    app: websocket-echo
  ports:
    - port: 8080
      targetPort: 8080
---
# Standalone pod for testing direct pod targeting (no service)
apiVersion: v1
kind: Pod
metadata:
  name: standalone-pod
  namespace: autotunnel-test
  labels:
    app: standalone-pod
spec:
  containers:
    - name: echo
      image: hashicorp/http-echo
      args: ["-text=direct-pod-test", "-listen=:8080"]
      ports:
        - containerPort: 8080
      readinessProbe:
        httpGet:
          path: /
          port: 8080
        initialDelaySeconds: 2
        periodSeconds: 3
---
# Echo server that reflects request headers (for testing X-Forwarded-* headers)
# Using ealen/echo-server which returns all request info as JSON
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-headers
  namespace: autotunnel-test
  labels:
    app: echo-headers
spec:
  replicas: 1
  selector:
    matchLabels:
      app: echo-headers
  template:
    metadata:
      labels:
        app: echo-headers
    spec:
      containers:
        - name: echo
          image: ealen/echo-server:latest
          ports:
            - containerPort: 80
          env:
            - name: PORT
              value: "80"
          readinessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 2
            periodSeconds: 3
---
# Service for echo-headers
apiVersion: v1
kind: Service
metadata:
  name: echo-headers
  namespace: autotunnel-test
spec:
  selector:
    app: echo-headers
  ports:
    - port: 80
      targetPort: 80
---
# ============================================================================
# TCP Echo Services for TCP port-forwarding integration tests
# ============================================================================

# TCP Echo Service using socat - echoes back any data sent to it
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tcp-echo
  namespace: autotunnel-test
  labels:
    app: tcp-echo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tcp-echo
  template:
    metadata:
      labels:
        app: tcp-echo
    spec:
      containers:
        - name: tcp-echo
          image: alpine:latest
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache socat &&
              socat TCP-LISTEN:9999,reuseaddr,fork EXEC:'cat'
          ports:
            - containerPort: 9999
              name: tcp
          readinessProbe:
            tcpSocket:
              port: 9999
            initialDelaySeconds: 5
            periodSeconds: 3
---
# Service for tcp-echo
apiVersion: v1
kind: Service
metadata:
  name: tcp-echo
  namespace: autotunnel-test
spec:
  selector:
    app: tcp-echo
  ports:
    - port: 9999
      targetPort: 9999
      name: tcp
---
# Second TCP Echo Service on different port for multi-route testing
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tcp-echo-alt
  namespace: autotunnel-test
  labels:
    app: tcp-echo-alt
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tcp-echo-alt
  template:
    metadata:
      labels:
        app: tcp-echo-alt
    spec:
      containers:
        - name: tcp-echo
          image: alpine:latest
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache socat &&
              socat TCP-LISTEN:9998,reuseaddr,fork EXEC:'cat'
          ports:
            - containerPort: 9998
              name: tcp
          readinessProbe:
            tcpSocket:
              port: 9998
            initialDelaySeconds: 5
            periodSeconds: 3
---
# Service for tcp-echo-alt
apiVersion: v1
kind: Service
metadata:
  name: tcp-echo-alt
  namespace: autotunnel-test
spec:
  selector:
    app: tcp-echo-alt
  ports:
    - port: 9998
      targetPort: 9998
      name: tcp
---
# Standalone TCP Echo Pod for direct pod targeting tests (no service)
apiVersion: v1
kind: Pod
metadata:
  name: tcp-echo-standalone
  namespace: autotunnel-test
  labels:
    app: tcp-echo-standalone
spec:
  containers:
    - name: tcp-echo
      image: alpine:latest
      command:
        - /bin/sh
        - -c
        - |
          apk add --no-cache socat &&
          socat TCP-LISTEN:9999,reuseaddr,fork EXEC:'cat'
      ports:
        - containerPort: 9999
          name: tcp
      readinessProbe:
        tcpSocket:
          port: 9999
        initialDelaySeconds: 10
        periodSeconds: 5
---
# ============================================================================
# Jump-Host (Socat) Services for exec+socat integration tests
# These services test the socat/jump-host functionality:
# - bastion-jump: Jump pod discovered via Service
# - bastion-standalone: Jump pod targeted directly by name
# - tcp-target: Simulates an external service (RDS/Cloud SQL) that's only
#   reachable through the jump pod (in reality, it's reachable from anywhere
#   in the cluster, but conceptually represents an external service)
# ============================================================================

# Bastion/Jump Pod Deployment - Has socat and nc installed for jump-host testing
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bastion-jump
  namespace: autotunnel-test
  labels:
    app: bastion-jump
spec:
  replicas: 1
  selector:
    matchLabels:
      app: bastion-jump
  template:
    metadata:
      labels:
        app: bastion-jump
    spec:
      containers:
        - name: bastion
          image: alpine:3.19
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache socat netcat-openbsd &&
              echo "Bastion pod ready with socat and nc" &&
              sleep infinity
          readinessProbe:
            exec:
              command: ["which", "socat"]
            initialDelaySeconds: 5
            periodSeconds: 3
---
# Service for bastion-jump (for service-based via discovery)
apiVersion: v1
kind: Service
metadata:
  name: bastion-jump
  namespace: autotunnel-test
spec:
  selector:
    app: bastion-jump
  ports:
    - port: 22
      targetPort: 22
      name: ssh
---
# Standalone bastion pod (for direct pod targeting tests)
apiVersion: v1
kind: Pod
metadata:
  name: bastion-standalone
  namespace: autotunnel-test
  labels:
    app: bastion-standalone
spec:
  containers:
    - name: bastion
      image: alpine:3.19
      command:
        - /bin/sh
        - -c
        - |
          apk add --no-cache socat netcat-openbsd &&
          echo "Standalone bastion pod ready" &&
          sleep infinity
      readinessProbe:
        exec:
          command: ["which", "socat"]
        initialDelaySeconds: 5
        periodSeconds: 3
---
# TCP Target Service - Simulates external service (RDS, Cloud SQL, etc.)
# The jump pod connects TO this service
# Uses socat TCP echo on port 3306 (MySQL-like)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tcp-target
  namespace: autotunnel-test
  labels:
    app: tcp-target
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tcp-target
  template:
    metadata:
      labels:
        app: tcp-target
    spec:
      containers:
        - name: tcp-echo
          image: alpine:3.19
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache socat &&
              socat TCP-LISTEN:3306,reuseaddr,fork EXEC:'cat'
          ports:
            - containerPort: 3306
              name: mysql
          readinessProbe:
            tcpSocket:
              port: 3306
            initialDelaySeconds: 5
            periodSeconds: 3
---
# Service for tcp-target
apiVersion: v1
kind: Service
metadata:
  name: tcp-target
  namespace: autotunnel-test
spec:
  selector:
    app: tcp-target
  ports:
    - port: 3306
      targetPort: 3306
      name: mysql
---
# ============================================================================
# Multi-container bastion pod for container selection testing
# Tests the via.container config option to select specific container
# ============================================================================
apiVersion: v1
kind: Pod
metadata:
  name: multi-container-bastion
  namespace: autotunnel-test
  labels:
    app: multi-container-bastion
spec:
  containers:
    # Main container - runs a simple HTTP server (not used for jump)
    - name: main
      image: hashicorp/http-echo
      args: ["-text=main-container", "-listen=:8080"]
      ports:
        - containerPort: 8080
          name: http
    # Socat container - used for jump functionality
    - name: socat
      image: alpine:3.19
      command:
        - /bin/sh
        - -c
        - |
          apk add --no-cache socat &&
          echo "Socat container ready" &&
          sleep infinity
      readinessProbe:
        exec:
          command: ["which", "socat"]
        initialDelaySeconds: 5
        periodSeconds: 3
---
# ============================================================================
# NC-only bastion pod for testing netcat fallback (no socat installed)
# Uses busybox which has nc but not socat
# ============================================================================
apiVersion: v1
kind: Pod
metadata:
  name: nc-only-bastion
  namespace: autotunnel-test
  labels:
    app: nc-only-bastion
spec:
  containers:
    - name: bastion
      image: busybox:1.36
      command:
        - /bin/sh
        - -c
        - |
          echo "NC-only bastion ready (no socat)" &&
          sleep infinity
      readinessProbe:
        exec:
          command: ["which", "nc"]
        initialDelaySeconds: 2
        periodSeconds: 3
